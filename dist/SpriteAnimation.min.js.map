{"version":3,"file":"SpriteAnimation.min.js","sources":["../src/index.js","../src/utils.js"],"sourcesContent":["import utils from './utils';\n\nfunction SpriteAnimation(...options) {\n    //兼容不写new 的情况\n    if (!(this instanceof SpriteAnimation)) return new SpriteAnimation(options);\n\n    console.log('options1',options);\n\n    this.init(options);\n\n}\n\nSpriteAnimation.prototype = {\n    init(options){\n        if (!options || !options[0] || !utils.isObject(options[1])) return new Error('this argument is wrong');\n\n        if (!utils.$(options[0])) return new Error('can not get this Dom');\n\n        this.ele = utils.$(options[0]);\n\n        if(!this.ele.scrollWidth || !this.ele.scrollHeight) return new Error('this ele argument is wrong');\n\n        this.defaultConfigOptions = {\n            image: '',\n            width: 0,\n            height: 0,\n            padding: 0,\n            frames: 0,\n            duration: '2s',\n            loop: true,\n            imageProcess(){},\n            imageLoaded(){},\n            animationCompleted(){},\n            animationFrame(){},\n        };\n\n        this.configOptions = Object.assign(this.defaultConfigOptions, options[1]);\n\n        utils.isString(this.configOptions.image) ? this.initCanvas().loadImage(this.configOptions.image) : this.initCanvas().loadImages(this.configOptions.image);\n\n    },\n    initCanvas(){\n        this.canvas = document.createElement('canvas');\n        this.ctx = this.canvas.getContext('2d');\n        this.canvas.width = this.ele.scrollWidth;\n        this.canvas.height = this.ele.scrollHeight;\n        this.ele.appendChild(this.canvas);\n\n        return this;\n    },\n    loadImage(url){\n        this.sourceImage = new Image();\n        this.sourceImage.setAttribute('crossOrigin', 'anonymous');\n        this.sourceImage.onload = () =>{\n            this.sourceImageW = this.sourceImage.naturalWidth;\n            this.sourceImageH = this.sourceImage.naturalHeight;\n            this.configOptions.imageLoaded && this.configOptions.imageLoaded();\n            this.getRowCol();\n        };\n        this.sourceImage.src = url;\n    },\n    loadImages(imageArr){\n        this.sourceImages = [];\n        let imageCount = 0;\n        imageArr.length === 0 && setTimeout(() => this.configOptions.imageLoaded && this.configOptions.imageLoaded(), 0);\n\n        imageArr.map((item, index) => {\n            this.sourceImages[index] = new Image();\n            this.sourceImages[index].setAttribute('crossOrigin', 'anonymous');\n            this.sourceImages[index].onload = () =>{\n                imageCount++;\n                this.configOptions.imageProcess && this.configOptions.imageProcess((imageCount / imageArr.length).toFixed(2));\n                if (imageCount === imageArr.length) {\n                    this.configOptions.imageLoaded && this.configOptions.imageLoaded();\n\n                    this.configOptions.frames = imageArr.length;\n                    this.interval = utils.getRealVal(this.configOptions.duration) * 1000 / this.configOptions.frames;\n                    this.thenTime = Date.now();\n\n                    this.framesIndex = 0;\n                    this.computeTime();\n                }\n            };\n            this.sourceImages[index].src = item;\n        });\n    },\n    getRowCol(){\n        this.rowCount = Math.floor((this.sourceImageW + this.configOptions.padding) / (this.configOptions.width + this.configOptions.padding));\n        this.colCount = Math.floor((this.sourceImageH + this.configOptions.padding) / (this.configOptions.height + this.configOptions.padding));\n\n        if (this.rowCount * this.colCount < this.configOptions.frames ) return new Error('this sprite wrong');\n\n        this.rowIndex = 1;\n        this.colIndex = 1;\n\n        this.framesIndex = 1;\n\n        this.interval = utils.getRealVal(this.configOptions.duration) * 1000 / this.configOptions.frames;\n\n        this.thenTime = Date.now();\n\n        this.computeTime();\n    },\n    computeTime(){\n        this.nowTime = Date.now();\n        this.delta = this.nowTime - this.thenTime;\n        this.RAF = window.requestAnimationFrame(() => this.computeTime());\n        if (this.delta > this.interval){\n            // 这里不能简单this.thenTime=this.nowTime，会出现细微时间差问题。例如frames=10，每帧100ms，而现在每16ms执行一次drawImage。16*7=112>100，需要7次才实际绘制一次。这个情况下，实际10帧需要112*10=1120ms>1000ms才绘制完成。\n            this.thenTime = this.nowTime - (this.delta % this.interval);\n            this.drawImage();\n        }\n    },\n    drawImage(){\n        if (utils.isString(this.configOptions.image)){\n            this.sx = (this.rowIndex - 1) * (this.configOptions.width + this.configOptions.padding);\n            this.sy = (this.colIndex - 1) * (this.configOptions.height + this.configOptions.padding);\n\n            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\n            this.ctx.drawImage(this.sourceImage, this.sx, this.sy, this.configOptions.width, this.configOptions.height, 0, 0, this.canvas.width, this.canvas.height);\n\n            //左->右 上->下\n            if ((this.rowIndex - 1) * (this.configOptions.width + this.configOptions.padding) < this.sourceImageW){\n                this.rowIndex += 1;\n            }\n            if (this.rowIndex > this.rowCount){\n                this.rowIndex = 1;\n                this.colIndex += 1;\n            }\n\n            this.configOptions.animationFrame && this.configOptions.animationFrame(this.framesIndex);\n\n            this.framesIndex ++;\n\n            if (this.framesIndex > this.configOptions.frames && this.configOptions.loop) {\n                this.rowIndex = 1;\n                this.colIndex = 1;\n                this.framesIndex = 1;\n            }\n            else if ((this.framesIndex > this.configOptions.frames) && !this.configOptions.loop){\n                this.rowIndex = ((this.rowCount * this.colCount) > this.configOptions.frames ) ? ((this.configOptions.frames % this.rowCount) === 0 ? 1 : (this.configOptions.frames % this.rowCount)) :  this.rowCount;\n                this.colIndex = ((this.rowCount * this.colCount) > this.configOptions.frames ) ? Math.floor(this.configOptions.frames / this.rowCount) + 1 : this.colCount;\n\n                this.sx = (this.rowIndex - 1) * (this.configOptions.width + this.configOptions.padding);\n                this.sy = (this.colIndex - 1) * (this.configOptions.height + this.configOptions.padding);\n\n                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\n                this.ctx.drawImage(this.sourceImage, this.sx, this.sy, this.configOptions.width, this.configOptions.height, 0, 0, this.canvas.width, this.canvas.height);\n\n                window.cancelAnimationFrame(this.RAF);\n\n                this.configOptions.animationCompleted && this.configOptions.animationCompleted();\n            }\n        }\n        else {\n            this.sx = 0;\n            this.sy = 0;\n            this.sw = this.sourceImages[this.framesIndex].naturalWidth;\n            this.sh = this.sourceImages[this.framesIndex].naturalHeight;\n            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\n            this.ctx.drawImage(this.sourceImages[this.framesIndex], this.sx, this.sy, this.sw, this.sh, 0, 0, this.canvas.width, this.canvas.height);\n\n            this.configOptions.animationFrame && this.configOptions.animationFrame(this.framesIndex + 1);\n\n            this.framesIndex++;\n\n            if ((this.framesIndex === this.configOptions.frames) && this.configOptions.loop){\n                this.framesIndex = 0;\n            }\n            else if ((this.framesIndex === this.configOptions.frames) && !this.configOptions.loop){\n                window.cancelAnimationFrame(this.RAF);\n                this.configOptions.animationCompleted && this.configOptions.animationCompleted();\n            }\n        }\n\n    },\n};\n\nwindow.requestAnimationFrame = (function() {\n    return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || function(callback) {\n        window.setTimeout(callback, 1000 / 60);\n    };\n})();\nwindow.cancelAnimationFrame = (window.cancelRequestAnimationFrame || window.webkitCancelAnimationFrame || window.webkitCancelRequestAnimationFrame || window.mozCancelAnimationFrame || window.mozCancelRequestAnimationFrame || window.msCancelAnimationFrame || window.msCancelRequestAnimationFrame || window.oCancelAnimationFrame || window.oCancelRequestAnimationFrame || window.clearTimeout);\n\nexport default SpriteAnimation;\n","export default {\n    //判断对象\n    isObject: function (obj) {\n        //{},[],null 用typeof检测不出来\n        return Object.prototype.toString.call(obj) === '[object Object]';\n    },\n    isString(val) {\n        return typeof val === 'string';\n    },\n    isNumber(val) {\n        //isFinite 检测是否为无穷大\n        //isNumber(parseInt(a))   // true\n        // 第一种写法\n        return typeof val === 'number' && isFinite(val);\n        //第二种写法\n        // return typeof val === 'number' && !isNaN(val)\n    },\n    isPx(val){\n        return this.isString(val) && val.trim().endsWith('px');\n    },\n    isSecond(val){\n        return this.isString(val) && val.trim().endsWith('s');\n    },\n\n    $(ele){\n        if(document.querySelector){\n            return document.querySelector(ele);\n        } else {\n            if (ele.indexOf('#') > -1){\n                return document.getElementById(ele.replace('#',''));\n            } else if (ele.indexOf('.') > -1){\n                return document.getElementsByClassName(ele.replace('.',''))[0];\n            } else {\n                return document.getElementsByTagName(ele)[0];\n            }\n        }\n    },\n    getRealVal(val){\n        return parseInt(val);\n    },\n\n};"],"names":["SpriteAnimation","options","this","log","init","obj","Object","prototype","toString","call","val","isFinite","isString","trim","endsWith","ele","document","querySelector","indexOf","getElementById","replace","getElementsByClassName","getElementsByTagName","parseInt","utils","isObject","$","scrollWidth","scrollHeight","defaultConfigOptions","configOptions","assign","image","initCanvas","loadImage","loadImages","Error","canvas","createElement","ctx","getContext","width","height","appendChild","url","sourceImage","Image","setAttribute","onload","sourceImageW","_this","naturalWidth","sourceImageH","naturalHeight","imageLoaded","getRowCol","src","imageArr","sourceImages","imageCount","length","setTimeout","_this2","map","item","index","imageProcess","toFixed","frames","interval","getRealVal","duration","thenTime","Date","now","framesIndex","computeTime","rowCount","Math","floor","padding","colCount","rowIndex","colIndex","nowTime","delta","RAF","window","requestAnimationFrame","_this3","drawImage","sx","sy","clearRect","animationFrame","loop","cancelAnimationFrame","animationCompleted","sw","sh","webkitRequestAnimationFrame","mozRequestAnimationFrame","callback","cancelRequestAnimationFrame","webkitCancelAnimationFrame","webkitCancelRequestAnimationFrame","mozCancelAnimationFrame","mozCancelRequestAnimationFrame","msCancelAnimationFrame","msCancelRequestAnimationFrame","oCancelAnimationFrame","oCancelRequestAnimationFrame","clearTimeout"],"mappings":"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"}